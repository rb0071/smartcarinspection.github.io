<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF Video Upload with Preview</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: "Prompt", sans-serif;
      text-align: center;
      margin: 20px;
      background-color: #f8f8f8;
    }
    h1 {
      color: #333;
    }
    video {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button, input[type=file] {
      margin: 10px;
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #06C755;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

  <h1>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</h1>

  <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ô LINE -->
  <input type="file" id="videoInput" accept="video/*" capture="camera">

  <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
  <button id="startBtn">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
  <video id="video" autoplay playsinline muted></video>
  <button id="recordBtn" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</button>
  <button id="stopBtn" disabled>‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î</button>

  <!-- Preview ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå -->
  <h3>üéûÔ∏è ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</h3>
  <video id="previewVideo" controls style="display:none;"></video>

  <button id="uploadBtn" style="display:none;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</button>

  <div id="status"></div>

  <script>
    // ===== LIFF Initialization =====
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await liff.init({ liffId: "2008338659-J451kb28" }); // <-- ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        console.log("LIFF initialized");
      } catch (err) {
        console.warn("LIFF init failed:", err);
      }
    });

    const videoInput = document.getElementById("videoInput");
    const startBtn = document.getElementById("startBtn");
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const video = document.getElementById("video");
    const previewVideo = document.getElementById("previewVideo");
    const uploadBtn = document.getElementById("uploadBtn");

    let mediaRecorder;
    let recordedChunks = [];
    let finalBlob = null;

    // ====== ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ / LIFF ======
    videoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      finalBlob = file;
      const url = URL.createObjectURL(file);
      previewVideo.src = url;
      previewVideo.style.display = "block";
      uploadBtn.style.display = "inline-block";
    });

    // ====== ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö browser ‡∏õ‡∏Å‡∏ï‡∏¥ ======
    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;
        recordBtn.disabled = false;
        recordBtn.onclick = () => startRecording(stream);
      } catch (err) {
        showDialog("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
      }
    };

    function startRecording(stream) {
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        finalBlob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(finalBlob);
        previewVideo.src = url;
        previewVideo.style.display = "block";
        uploadBtn.style.display = "inline-block";
        showDialog("‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏î‡∏π‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
      };

      mediaRecorder.start();
      showDialog("üé• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...");
      recordBtn.disabled = true;
      stopBtn.disabled = false;
      stopBtn.onclick = () => mediaRecorder.stop();
    }

    // ====== ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ======
    uploadBtn.onclick = async () => {
      if (!finalBlob) {
        showDialog("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        return;
      }

      const formData = new FormData();
      formData.append("file", finalBlob, "video.webm");

      showDialog("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...");

      try {
        const res = await fetch("https://yourserver.com/upload", { // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
          method: "POST",
          body: formData
        });
        const data = await res.json();
        showDialog(data.success ? "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } catch (err) {
        showDialog("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    };

    function showDialog(msg) {
      document.getElementById("status").textContent = msg;
      console.log(msg);
    }
  </script>

</body>
</html>
