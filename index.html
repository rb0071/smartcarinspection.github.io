<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF Video Upload with Preview & Retake</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: "Prompt", sans-serif;
      text-align: center;
      margin: 20px;
      background-color: #f8f8f8;
    }
    h1 {
      color: #333;
    }
    video {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button, input[type=file] {
      margin: 10px;
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #06C755;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
    }
    #deleteBtn {
      background-color: #e74c3c;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

  <h1>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß & ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà)</h1>

  <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LINE LIFF -->
  <input type="file" id="videoInput" accept="video/*" capture="environment">

  <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
  <button id="startBtn">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
  <video id="video" autoplay playsinline muted></video>
  <button id="recordBtn" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</button>
  <button id="stopBtn" disabled>‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î</button>

  <!-- Preview -->
  <h3>üéûÔ∏è ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏£‡πâ‡∏≤</h3>
  <video id="previewVideo" controls style="display:none;"></video>

  <div>
    <button id="uploadBtn" style="display:none;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠</button>
    <button id="deleteBtn" style="display:none;">‡∏•‡∏ö‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠ / ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div id="status"></div>

  <script>
    // ===== LIFF Initialization =====
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await liff.init({ liffId: "2008338659-J451kb28" }); // üîë ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        console.log("‚úÖ LIFF initialized");
      } catch (err) {
        console.warn("‚ö†Ô∏è LIFF init failed:", err);
      }
    });

    const videoInput = document.getElementById("videoInput");
    const startBtn = document.getElementById("startBtn");
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const video = document.getElementById("video");
    const previewVideo = document.getElementById("previewVideo");
    const uploadBtn = document.getElementById("uploadBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    let mediaRecorder;
    let recordedChunks = [];
    let finalBlob = null;
    let videoStream = null;

    // ===== ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ / LIFF =====
    videoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      preview(file);
    });

    // ===== ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö browser ‡∏õ‡∏Å‡∏ï‡∏¥ =====
    startBtn.onclick = async () => {
      try {
        // üîÅ ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (facingMode: "environment")
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } },
          audio: true
        }).catch(async (err) => {
          console.warn("‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°, ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡∏ô:", err);
          return await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        });

        videoStream = stream;
        video.srcObject = stream;
        recordBtn.disabled = false;
        showDialog("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠");
        recordBtn.onclick = () => startRecording(stream);
      } catch (err) {
        showDialog("‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
      }
    };

    function startRecording(stream) {
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        finalBlob = new Blob(recordedChunks, { type: "video/webm" });
        preview(finalBlob);
      };

      mediaRecorder.start();
      showDialog("üé• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...");
      recordBtn.disabled = true;
      stopBtn.disabled = false;
      stopBtn.onclick = () => mediaRecorder.stop();
    }

    // ===== ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß =====
    function preview(fileOrBlob) {
      const url = URL.createObjectURL(fileOrBlob);
      finalBlob = fileOrBlob;
      previewVideo.src = url;
      previewVideo.style.display = "block";
      uploadBtn.style.display = "inline-block";
      deleteBtn.style.display = "inline-block";

      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÅ‡∏ö‡∏ï
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      recordBtn.disabled = true;
      stopBtn.disabled = true;
      showDialog("‚úÖ ‡∏î‡∏π‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß");
    }

    // ===== ‡∏•‡∏ö‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠ / ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà =====
    deleteBtn.onclick = () => {
      finalBlob = null;
      previewVideo.src = "";
      previewVideo.style.display = "none";
      uploadBtn.style.display = "none";
      deleteBtn.style.display = "none";
      videoInput.value = "";
      showDialog("üîÅ ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ");
      startBtn.disabled = false;
      recordBtn.disabled = true;
      stopBtn.disabled = true;
    };

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î =====
    uploadBtn.onclick = async () => {
      if (!finalBlob) {
        showDialog("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        return;
      }

      const formData = new FormData();
      formData.append("file", finalBlob, "video.webm");

      showDialog("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...");

      try {
        const res = await fetch("https://yourserver.com/upload", { // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
          method: "POST",
          body: formData
        });
        const data = await res.json();
        showDialog(data.success ? "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } catch (err) {
        showDialog("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    };

    function showDialog(msg) {
      document.getElementById("status").textContent = msg;
      console.log(msg);
    }
  </script>

</body>
</html>
